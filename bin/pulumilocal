#!/usr/bin/env python

"""
Thin wrapper around the "pulumi" command line interface (CLI) to use
Pulumi (https://pulumi.com) with LocalStack (https://localstack.cloud).

Options:
  Run "pulumi -h" for more details on the pulumi CLI subcommands.
"""

import os
import sys
import argparse
import subprocess

# for local testing
PARENT_FOLDER = os.path.realpath(os.path.join(os.path.dirname(__file__), '..'))
if os.path.isdir(os.path.join(PARENT_FOLDER, '.venv')):
    sys.path.insert(0, PARENT_FOLDER)

# define global constants
TRUE_STRINGS = ['1', 'true', 'True']
PULUMI_CMD = os.environ.get('PULUMI_CMD') or 'pulumi'
LOCALSTACK_HOSTNAME = os.environ.get('LOCALSTACK_HOSTNAME') or 'localhost'
EDGE_PORT = int(os.environ.get('EDGE_PORT') or '4566')
USE_SSL = os.environ.get('USE_SSL') in TRUE_STRINGS

# Do not allow PULUMI_CMD env var to be set to pulumilocal as this causes an error
if PULUMI_CMD == "pulumilocal":
    PULUMI_CMD = "pulumi"

# Unfortunately, we need to hardcode the service names here, as importing from
# localstack-client doesn't work (some keys differ / are unavailable in Pulumi)
SERVICES = [
    'accessanalyzer',
    'account',
    'acm',
    'acmpca',
    'amg',
    'amp',
    'amplify',
    'apigateway',
    'apigatewayv2',
    'appautoscaling',
    'appconfig',
    'appflow',
    'appintegrations',
    'appintegrationsservice',
    'applicationautoscaling',
    'applicationinsights',
    'appmesh',
    'apprunner',
    'appstream',
    'appsync',
    'athena',
    'auditmanager',
    'autoscaling',
    'autoscalingplans',
    'backup',
    'batch',
    'beanstalk',
    'budgets',
    'ce',
    'chime',
    'chimesdkmediapipelines',
    'chimesdkvoice',
    'cleanrooms',
    'cloud9',
    'cloudcontrol',
    'cloudcontrolapi',
    'cloudformation',
    'cloudfront',
    'cloudhsm',
    'cloudhsmv2',
    'cloudsearch',
    'cloudtrail',
    'cloudwatch',
    'cloudwatchevents',
    'cloudwatchevidently',
    'cloudwatchlog',
    'cloudwatchlogs',
    'cloudwatchobservabilityaccessmanager',
    'cloudwatchrum',
    'codeartifact',
    'codebuild',
    'codecatalyst',
    'codecommit',
    'codedeploy',
    'codegurureviewer',
    'codepipeline',
    'codestarconnections',
    'codestarnotifications',
    'cognitoidentity',
    'cognitoidentityprovider',
    'cognitoidp',
    'comprehend',
    'computeoptimizer',
    'config',
    'configservice',
    'connect',
    'controltower',
    'costandusagereportservice',
    'costexplorer',
    'cur',
    'databasemigration',
    'databasemigrationservice',
    'dataexchange',
    'datapipeline',
    'datasync',
    'dax',
    'deploy',
    'detective',
    'devicefarm',
    'directconnect',
    'directoryservice',
    'dlm',
    'dms',
    'docdb',
    'docdbelastic',
    'ds',
    'dynamodb',
    'ec2',
    'ecr',
    'ecrpublic',
    'ecs',
    'efs',
    'eks',
    'elasticache',
    'elasticbeanstalk',
    'elasticloadbalancing',
    'elasticloadbalancingv2',
    'elasticsearch',
    'elasticsearchservice',
    'elastictranscoder',
    'elb',
    'elbv2',
    'emr',
    'emrcontainers',
    'emrserverless',
    'es',
    'eventbridge',
    'events',
    'evidently',
    'finspace',
    'firehose',
    'fis',
    'fms',
    'fsx',
    'gamelift',
    'glacier',
    'globalaccelerator',
    'glue',
    'grafana',
    'greengrass',
    'guardduty',
    'healthlake',
    'iam',
    'identitystore',
    'imagebuilder',
    'inspector',
    'inspector2',
    'inspectorv2',
    'internetmonitor',
    'iot',
    'iotanalytics',
    'iotevents',
    'ivs',
    'ivschat',
    'kafka',
    'kafkaconnect',
    'kendra',
    'keyspaces',
    'kinesis',
    'kinesisanalytics',
    'kinesisanalyticsv2',
    'kinesisvideo',
    'kms',
    'lakeformation',
    'lambda',
    'lex',
    'lexmodelbuilding',
    'lexmodelbuildingservice',
    'lexmodels',
    'lexmodelsv2',
    'lexv2models',
    'licensemanager',
    'lightsail',
    'location',
    'locationservice',
    'logs',
    'macie2',
    'managedgrafana',
    'mediaconnect',
    'mediaconvert',
    'medialive',
    'mediapackage',
    'mediastore',
    'memorydb',
    'mq',
    'msk',
    'mwaa',
    'neptune',
    'networkfirewall',
    'networkmanager',
    'oam',
    'opensearch',
    'opensearchserverless',
    'opensearchservice',
    'opsworks',
    'organizations',
    'outposts',
    'pinpoint',
    'pipes',
    'pricing',
    'prometheus',
    'prometheusservice',
    'qldb',
    'quicksight',
    'ram',
    'rbin',
    'rds',
    'recyclebin',
    'redshift',
    'redshiftdata',
    'redshiftdataapiservice',
    'redshiftserverless',
    'resourceexplorer2',
    'resourcegroups',
    'resourcegroupstagging',
    'resourcegroupstaggingapi',
    'rolesanywhere',
    'route53',
    'route53domains',
    'route53recoverycontrolconfig',
    'route53recoveryreadiness',
    'route53resolver',
    'rum',
    's3',
    's3api',
    's3control',
    's3outposts',
    'sagemaker',
    'scheduler',
    'schemas',
    'sdb',
    'secretsmanager',
    'securityhub',
    'securitylake',
    'serverlessapplicationrepository',
    'serverlessapprepo',
    'serverlessrepo',
    'servicecatalog',
    'servicediscovery',
    'servicequotas',
    'ses',
    'sesv2',
    'sfn',
    'shield',
    'signer',
    'simpledb',
    'sns',
    'sqs',
    'ssm',
    'ssmcontacts',
    'ssmincidents',
    'ssoadmin',
    'stepfunctions',
    'storagegateway',
    'sts',
    'swf',
    'synthetics',
    'timestreamwrite',
    'transcribe',
    'transcribeservice',
    'transfer',
    'verifiedpermissions',
    'vpclattice',
    'waf',
    'wafregional',
    'wafv2',
    'worklink',
    'workspaces',
    'xray',
]


def get_service_endpoint():
    protocol = 'https' if USE_SSL else 'http'
    endpoint = '%s://%s:%s' % (protocol, LOCALSTACK_HOSTNAME, EDGE_PORT)
    return endpoint


def set_localstack_pulumi_config(args: argparse.Namespace):
    # LocalStack Endpoint
    service_url = get_service_endpoint()
    # Create argument list to pulumi config set-all
    config_args = list()
    config_args.append(PULUMI_CMD)
    config_args.append("config")
    # If stack arg was supplied, add it to config command
    if args.stack is not None:
        config_args.append("--stack")
        config_args.append(args.stack)
    # If cwd arg was supplied, add it to config command
    if args.cwd is not None:
        config_args.append("--cwd")
        config_args.append(args.cwd)
    config_args.append("set-all")
    config_args.append("--plaintext")
    config_args.append("aws:region=us-east-1")
    config_args.append("--plaintext")
    config_args.append("aws:accessKey=test")
    config_args.append("--plaintext")
    config_args.append("aws:secretKey=test")
    config_args.append("--plaintext")
    config_args.append("aws:s3UsePathStyle=true")
    config_args.append("--plaintext")
    config_args.append("aws:skipCredentialsValidation=true")
    config_args.append("--plaintext")
    config_args.append("aws:skipRequestingAccountId=true")
    # Add the AWS Endpoints list
    for idx, service in enumerate(SERVICES):
        config_args.append("--path")
        config_args.append("--plaintext")
        config_args.append(f"aws:endpoints[{idx}].{service}={service_url}")
    process = subprocess.Popen(executable=PULUMI_CMD, args=config_args, env=os.environ, stdout=subprocess.PIPE)
    process.wait()


def main():
    # Parse arguments from call to pulumi CLI that set the stack name and directory
    parser = argparse.ArgumentParser(add_help=False)
    parser.add_argument("command", help="pulumi primary command",
                        type=str)
    parser.add_argument("-s", "--stack", help="pulumi stack name",
                        required=False,
                        type=str)
    parser.add_argument("-C", "--cwd", help="run in this directory",
                        required=False,
                        type=str)
    args, extra = parser.parse_known_args()

    # If this is a pulumi deployment command, update the stack with LocalStack AWS config
    if args.command in ["up", "destroy", "preview", "cancel"]:
        print("Updating this Stack with LocalStack config")
        set_localstack_pulumi_config(args)
    # Run the original command
    return os.execvp(PULUMI_CMD, sys.argv)


if __name__ == '__main__':
    main()
